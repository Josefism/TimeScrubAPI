generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  ADMIN
}

model Company {
  id            Int          @id @default(autoincrement())
  name          String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  postalCode    String
  country       String       @default("US")
  phone         String?

  employees     Employee[]
  jobs          Job[]
  timeEntries   TimeEntry[]
  auditLogs     AuditLog[]

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Employee {
  id           Int          @id @default(autoincrement())
  company      Company      @relation(fields: [companyId], references: [id])
  companyId    Int

  email        String       @unique
  name         String
  role         Role         @default(EMPLOYEE)
  passwordHash String

  timeEntries  TimeEntry[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  deletedAt     DateTime?   @db.DateTime
  deletedBy     Int?
  deletedByUser Employee?   @relation("DeletedEmployeesBy", fields: [deletedBy], references: [id])

  deletedJobs   Job[]        @relation("DeletedJobsBy")
  deletedEmployees Employee[] @relation("DeletedEmployeesBy")

  auditLogs     AuditLog[]

  @@index([companyId])
  @@index([deletedAt])
}

model Job {
  id           Int          @id @default(autoincrement())
  company      Company      @relation(fields: [companyId], references: [id])
  companyId    Int

  name         String

  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String       @default("US")

  jobNote      String?      // admin notes for employees

  active       Boolean      @default(true)

  timeEntries  TimeEntry[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  deletedAt    DateTime?    @db.DateTime
  deletedBy    Int?
  deletedByUser Employee?   @relation("DeletedJobsBy", fields: [deletedBy], references: [id])

  @@index([companyId])
  @@index([deletedAt])
}

model TimeEntry {
  id          Int       @id @default(autoincrement())

  company     Company   @relation(fields: [companyId], references: [id])
  companyId   Int

  employee    Employee  @relation(fields: [employeeId], references: [id])
  employeeId  Int

  job         Job       @relation(fields: [jobId], references: [id])
  jobId       Int

  start       DateTime
  end         DateTime
  durationMs  Int

  timeNote    String?   // employee note for admin

  createdAt   DateTime  @default(now())

  @@index([companyId, start])
  @@index([employeeId, start])
  @@index([jobId, start])
}

model AuditLog {
  id          Int       @id @default(autoincrement())
  companyId   Int       // whose data this applies to
  employeeId  Int       // who performed the action
  action      String    // e.g. "JOB_ARCHIVED", "EMPLOYEE_CREATED", etc.
  entityType  String    // "job", "employee", "time_entry", "company"
  entityId    Int
  timestamp   DateTime  @default(now())
  metadata    Json?

  employee    Employee  @relation(fields: [employeeId], references: [id])
  company     Company   @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([employeeId])
  @@index([entityType, entityId])
}
